<%# Esta condición comprueba si el autor del post existe. Si no, no muestra nada. %>
<% if (post && post.userId) { %>

    <%
    let cardClasses = 'post-card';
    let cardStyle = '';
    if (post.boostedUntil && new Date(post.boostedUntil) > new Date() && post.boostOptions) {
        cardClasses += ' boosted'; // Añade una clase para el borde
        const boostColor = post.boostOptions.color || 'var(--primary-color)';
        // Define la variable de CSS que se usará en la hoja de estilos interna
        cardStyle = `style="--boost-color: ${boostColor}"`;
    }
    %>

    <div class="<%= cardClasses %>" <%- cardStyle %>>

        <% if(post.boostedUntil && new Date(post.boostedUntil) > new Date() && post.boostOptions) { %>
            <div class="boost-label">
                <i class="fas fa-rocket"></i> <%= post.boostOptions.label || 'Promocionado' %>
            </div>
        <% } %>

        <a href="/anuncio/<%= post._id %>" class="post-card-link">
    <% if (post.files && post.files.length > 0) { %>
        <%
            let thumbnailUrl = post.files[0];
            if (post.type === 'video') {
                // 1. Convertimos la URL del video a una URL de imagen (.jpg)
                thumbnailUrl = thumbnailUrl.replace(/\.(mp4|mov|avi)$/i, '.jpg');

                const isPaid = post.price > 0 && !post.isSubscriberOnly;
                const isSubscriber = post.isSubscriberOnly;

                // 2. Si el video es de pago o para suscriptores, aplicamos las transformaciones
                if (isPaid || isSubscriber) {
                    let transformations = 'e_blur:1200'; // Nivel de desenfoque

                    // 3. Añadimos el ícono correspondiente como una capa de texto
                    if (isPaid) {
                        // Superpone un ícono de dólar
                        transformations += '/l_text:Arial_150_bold:$,co_rgb:FFFFFF,o_80/fl_layer_apply,g_center';
                    } else if (isSubscriber) {
                        // Superpone un ícono de estrella (usando un carácter unicode)
                        transformations += '/l_text:Arial_150_bold:⭐,co_rgb:FFFFFF,o_80/fl_layer_apply,g_center';
                    }
                    
                    // 4. Insertamos las transformaciones en la URL de la imagen
                    const urlParts = thumbnailUrl.split('/upload/');
                    if (urlParts.length === 2) {
                        thumbnailUrl = urlParts[0] + '/upload/' + transformations + '/' + urlParts[1];
                    }
                }
            }
        %>
        <img src="<%= thumbnailUrl %>" alt="Anuncio de <%= post.userId.username %>" class="post-card-image">
    <% } %>

    <% if(post.type === 'video') { %>

                <div class="video-overlay">
                    <i class="fas fa-play"></i>
                </div>
                <% if (post.price > 0) { %>
                    <div class="content-lock-icon" title="Video de pago"><i class="fas fa-dollar-sign"></i></div>
                <% } else if (post.isSubscriberOnly) { %>
                    <div class="content-lock-icon" title="Solo para suscriptores"><i class="fas fa-star"></i></div>
                <% } %>
            <% } else if (post.isSubscriberOnly) { %>
                 <div class="content-lock-icon" title="Solo para suscriptores"><i class="fas fa-star"></i></div>
            <% } %>
        </a>

        <div class="post-card-info">
            <a href="/user/<%= post.userId.username %>" class="post-card-user">
                <img src="<%= post.userId.profilePic %>" alt="Avatar de <%= post.userId.username %>" class="avatar">
                <span style="display: inline-flex; align-items: center; gap: 6px;">
    <%= post.userId.username %>
    <% if (post.userId.isVerified) { %>
        <i class="fas fa-check-circle verification-badge" title="Cuenta Verificada"></i>
    <% } %>
</span>
            </a>
            <div class="post-card-actions">
    <button class="icon-btn share-btn" data-post-url="/anuncio/<%= post._id %>" title="Compartir">
        <i class="fas fa-share-square"></i>
    </button>
    <a href="/report?type=post&id=<%= post._id %>" class="icon-btn" title="Reportar">
        <i class="fas fa-flag"></i>
    </a>
</div>
             </div>
    </div>

<% } %>